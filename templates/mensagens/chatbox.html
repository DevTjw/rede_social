{% extends "base.html" %}

{% block content %}

<h2>ðŸ§© Sala: {{ chat_box_name }}</h2>

<style>
    #chat-box {
        height: 350px;
        overflow-y: auto;
        border: 1px solid #ddd;
        padding: 10px;
        border-radius: 8px;
        background: white;
    }
    .msg {
        margin-bottom: 10px;
        padding: 8px;
        border-radius: 6px;
        max-width: 70%;
    }
    .me { background: #d9fdd3; margin-left: auto; }
    .other { background: #ececec; }
    #input-area {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }
</style>

<div id="chat-box">
    {% for msg in mensagens %}
        <div class="msg {% if msg.remetente == request.user %}me{% else %}other{% endif %}">
            <strong>{{ msg.remetente.username }}:</strong><br>
            {{ msg.conteudo }}
        </div>
    {% endfor %}
</div>

<div id="input-area">
    <input type="text" id="mensagem" placeholder="Digite uma mensagem..." class="form-control">
    <button id="btn-enviar">Enviar</button>
</div>

<script>
const username = "{{ request.user.username }}";
const chatBoxName = "{{ chat_box_name }}";

const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat_box/{{ chat_box_name }}/"
);

socket.onmessage = function(e) {
    const data = JSON.parse(e.data);

    if (data.type === "message" || data.type === "group_message") {
        const box = document.getElementById("chat-box");
        const div = document.createElement("div");

        div.classList.add("msg");
        div.classList.add(data.remetente === username ? "me" : "other");
        div.innerHTML = "<strong>" + data.remetente + ":</strong><br>" + data.message;

        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }
};

document.getElementById("btn-enviar").onclick = function() {
    const msg = document.getElementById("mensagem").value;
    socket.send(JSON.stringify({
        type: "message",
        chat_box: chatBoxName,
        message: msg
    }));
    document.getElementById("mensagem").value = "";
};
</script>

{% endblock %}
