{% extends "base.html" %}
{% load static %}
{% block content %}
<html lang="pt-br" data-theme="{{ request.session.theme|default:'claro' }}">
<head>
<link rel="stylesheet" href="{% static 'css/mensagens/mensagem_geral.css' %}">
</head>


  <div class="chat-container">
    <!-- Coluna esquerda vazia -->
     
    <div class="col-left"></div>

    <!-- Área central de mensagem -->
    <main class="area-mensagem">
      <h3>Enviar mensagem para <span id="nome-destinatario">...</span></h3>

      <form method="post" id="form-mensagem" novalidate>
        {% csrf_token %}
        {{ form.destinatario }} {# campo hidden #}

        <label for="id_conteudo" class="form-label">Mensagem</label>
        {{ form.conteudo }}

        <button type="submit" class="btn-enviar" disabled id="btn-enviar">Enviar Mensagem</button>
      </form>
    </main>

    <!-- Sidebar direita: seguidores -->
    <aside class="sidebar-seguidores">
      <h4>Seus Seguidores</h4><br>
      {% if seguidores %}
        {% for seguidor in seguidores %}
          <div class="seguidor-item" data-username="{{ seguidor.username }}" data-nome="{{ seguidor.get_full_name|default:seguidor.username }}">
            {% if seguidor.perfil.foto_perfil %}
              <img src="{{ seguidor.perfil.foto_perfil.url }}" alt="{{ seguidor.username }}" class="seguidor-img" />
            {% else %}
              <i class="fas fa-user-circle fa-2x text-secondary"></i>
            {% endif %}
            <div>
              <div class="seguidor-nome">{{ seguidor.get_full_name|default:seguidor.username }}</div>
              <div class="seguidor-username">@{{ seguidor.username }}</div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <p class="text-center">Nenhum seguidor para mostrar.</p>
      {% endif %}
    </aside>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(function(){
      let destinatarioSelecionado = null;

      function selecionarSeguidor($item){
        $('.seguidor-item').removeClass('active');
        $item.addClass('active');

        const username = $item.data('username');
        const nome = $item.data('nome');

        destinatarioSelecionado = username;
        $('#nome-destinatario').text(nome);
        $('#id_destinatario').val(username);

        toggleBotaoEnviar();
      }

      function toggleBotaoEnviar(){
        const mensagem = $('#id_conteudo').val().trim();
        $('#btn-enviar').prop('disabled', !destinatarioSelecionado || mensagem.length === 0);
      }

      $('.seguidor-item').on('click', function(){
        selecionarSeguidor($(this));
      });

      $('#id_conteudo').on('input', toggleBotaoEnviar);

      $('#form-mensagem').on('submit', function(e){
        const mensagem = $('#id_conteudo').val().trim();
        if(!destinatarioSelecionado){
          alert('Selecione um destinatário clicando na lista de seguidores.');
          e.preventDefault();
          return;
        }
        if(mensagem.length === 0){
          $('#id_conteudo').addClass('is-invalid').focus();
          e.preventDefault();
        } else {
          $('#id_conteudo').removeClass('is-invalid');
        }
      });

      // Seleciona o primeiro seguidor automaticamente, se houver
      const $primeiroSeguidor = $('.seguidor-item').first();
      if ($primeiroSeguidor.length) {
        selecionarSeguidor($primeiroSeguidor);
      }
    });
  </script>
{% endblock %}