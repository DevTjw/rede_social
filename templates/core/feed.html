{% extends 'base.html' %}
{% load static %}
{% block content %}
<head>
    <link rel="stylesheet" href="{% static 'css/feed.css' %}">
</head>
{% include "mensagens/flutuante.html" %}
<div class="row">

    <!-- =======================
         COLUNA PRINCIPAL (POSTS)
    ======================== -->
    <div class="col-md-7">

        <!-- Card para criar novo post -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex mb-3">
                    <!-- Foto do usu√°rio logado -->
                    {% if user.perfil.foto_perfil %}
                    <img src="{{ user.perfil.foto_perfil.url }}" class="profile-pic-sm "
                        style="width: 35px; height: 35px; border-radius: 50%;"
                        title="{{ user.get_full_name|default:user.username }}">
                    {% else %}
                    <!-- √çcone padr√£o se n√£o houver foto -->
                    <i class="fas fa-user-circle fa-2x text-secondary me-2"></i>
                    {% endif %}&nbsp;&nbsp;
                    <!-- Formul√°rio para criar post -->
                    <div class="w-100">
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <textarea name="conteudo" class="form-control mb-2" placeholder="O que voc√™ est√° pensando?"
                                rows="3"></textarea>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <!-- Bot√£o para adicionar imagem -->
                                    <label for="imagem" class="btn btn-sm btn-outline-secondary mb-0">
                                        <i class="fas fa-image"></i> Foto
                                    </label>
                                    <input type="file" name="imagem" id="imagem" class="d-none" accept="image/*">
                                </div>
                                <button type="submit" class="btn btn-primary">Publicar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <!-- =======================
             LISTA DE POSTS EXISTENTES
        ======================== -->
        {% for post in posts|slice:":5" %}
        <div class="card post-card">
            <div class="card-body">

                <!-- Cabe√ßalho do post (autor, tempo e a√ß√µes) -->
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="d-flex">
                        <!-- Foto do autor -->
                        {% if post.autor.perfil.foto_perfil %}
                        <img src="{{ post.autor.perfil.foto_perfil.url }}" alt="{{ post.autor.username }}"
                            style="width: 35px; height: 35px; border-radius: 50%;" class="profile-pic-sm ">
                        {% else %}
                        <i class="fas fa-user-circle fa-2x text-secondary me-2"></i>
                        {% endif %}&nbsp;&nbsp;
                        <div title="">
                            <h5 class="card-title mb-0">
                                <a href="{% url 'perfil' post.autor.username %}" class="text-decoration-none">
                                    {{ post.autor.get_full_name|default:post.autor.username }}
                                </a>
                            </h5>
                            <small class="text-muted">{{ post.data_criacao|timesince }} atr√°s</small>
                        </div>
                    </div>
                </div>

                <!-- Conte√∫do do post -->
                <p class="card-text">{{ post.conteudo }}</p>

                <!-- Imagem do post (se existir) -->
                {% if post.imagem %}
                <img src="{{ post.imagem.url }}" class="img-fluid rounded mb-3" alt="Imagem do post"
                    title="Publicado por {{ post.autor.username }}">
                {% endif %}

                <!-- Contagem de curtidas e coment√°rios -->
                <div class="d-flex justify-content-between">
                    <span class="text-muted">
                        <span class="like-count">{{ post.curtidas.count }}</span> curtidas
                    </span>
                    <span class="text-muted">{{ post.comentarios.count }} coment√°rios</span>
                </div>

                <hr>

                <!-- Bot√µes de intera√ß√£o -->
                <div class="d-flex justify-content-around">
                    <!-- bot√£o Curtir  -->
                    <button
                        class="btn btn-sm btn-outline-primary like-btn {% if user in post.curtidas.all %}liked{% endif %}"
                        data-post-id="{{ post.id }}" data-like-url="{% url 'core:curtir_post' post.id %}">
                        <i class="{% if user in post.curtidas.all %}fas text-danger{% else %}far{% endif %} fa-heart"></i>
                        Curtidas<span class="like-count">{{ post.curtidas.count }}</span>
                    </button>&nbsp;

                    <!-- bot√£o Deletar (apenas para o autor do post) -->
                    {% if post.autor.perfil.foto_perfil == user.perfil.foto_perfil %}
                    <form action="{% url 'core:deletar_post' post.id %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" onclick="return confirm('Tem certeza que quer deletar este post?');"
                            class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-trash"></i> Del
                        </button>
                    </form>&nbsp;
                    {% else %}

                    {% endif %}
                    <!-- Bot√£o para comentar  abre comentarios -->
                    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse"
                        data-bs-target="#comments-{{ post.id }}" aria-expanded="false"
                        aria-controls="comments-{{ post.id }}">
                        <i class="far fa-comment"></i> Comentar
                    </button>&nbsp;
<!-- Compartilhar -->
                <!-- Dropdown Compartilhar do Post -->
                <div class="dropdown post-dropdown">
                <button 
                    class="btn btn-sm btn-outline-primary dropdown-toggle" 
                    type="button" 
                    id="dropdownCompartilhar{{ post.id }}" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    title="Clique para ver op√ß√µes de compartilhamento">
                    <i class="far fa-share-square"></i> Compartilhar
                </button>
                
                <ul class="dropdown-menu" aria-labelledby="dropdownCompartilhar{{ post.id }}">

                    <li>
                    <a class="dropdown-item" href="javascript:void(0);" 
                        data-post-id="{{ post.id }}" title="Abrir modal para compartilhar este post aqui com outros contatos"
                        onclick="abrirModalCompartilhar(this)">
                        <i class="far fa-share-square"></i> Contatos
                    </a>
                    </li>
                    <li>
                    <a class="dropdown-item" href="javascript:void(0);" onclick="prepararECompartilhar('{{ post.id }}')"
                    title="Preparar o post e compartilhar em outras redes sociais">
                        <i class="far fa-share-square"></i> APPs
                    </a>
                    </li>
                    <li>
                    <a class="dropdown-item"
                    target="_blank"
                    title="Compartilhar este post pelo WhatsApp"
                    href="https://wa.me/?text={{ 'Veja esse post:'|urlencode }}%20{{ request.scheme }}://{{ request.get_host }}{% url 'core:post_detail' post.id %}">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </a>

                    </li>
                </ul>
                </div>

                </div>
                <!-- =======================
                     √ÅREA DE COMENT√ÅRIOS
                ======================== -->
                <div class="collapse mt-3" id="comments-{{ post.id }}">
                    <div class="comments-container"></div>
                    <div id="mensagem-status"></div>
                    <hr>
                    <!-- Formul√°rio para adicionar novo coment√°rio -->
                    <div id="comentarios-{{ post.id }}">
                        <form method="post" class="comment-form" data-post-id="{{ post.id }}">
                            {% csrf_token %}
                            <div class="input-group">
                                <textarea class="form-control" placeholder="Comente algo..." required></textarea>
                                <button type="submit" class="btn btn-primary">Comentar</button>
                            </div>
                        </form>


                    </div>
                    <hr>
                    <!-- Lista dos 5 ultimos coment√°rios -->
                    {% for comentario in post.comentarios.all|dictsortreversed:"data_criacao"|slice:":5" %}

                    <div class="card mb-2 comentario " data-id="{{ comentario.id }}">
                        <div class="card-body py-2">
                            <div class="d-flex">
                                {% if comentario.autor.perfil.foto_perfil %}
                                <img src="{{ comentario.autor.perfil.foto_perfil.url}}" class="profile-pic-sm me-2"
                                    style="width: 35px; height: 35px; border-radius: 50%;"
                                    title="{{ comentario.autor.get_full_name|default:comentario.autor.username }}">
                                {% else %}
                                <!-- √çcone padr√£o se n√£o houver foto -->
                                <i class="fas fa-user-circle fa-2x text-secondary me-2"></i>
                                {% endif %}
                                <div>
                                    <strong>{{ comentario.autor.username }}</strong>
                                    <p class="mb-0 comentario-texto">{{ comentario.texto }}</p>
                                    <small class="text-muted">{{ comentario.data_criacao|timesince }} atr√°s</small>

                                    <!-- Bot√µes de editar/excluir (somente autor ou staff) -->
                                    {% if comentario.autor == request.user or request.user.is_staff %}
                                    <!-- Bot√£o para abrir o Modal -->
                                    <button type="button" class="btn btn-sm btn-link text-primary p-0 editar-comentario"
                                        data-bs-toggle="modal" data-bs-target="#modalEditarComentario"
                                        data-comentario-id="{{ comentario.id }}"
                                        data-comentario-texto="{{ comentario.texto|escape }}">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>

                                    <button class="btn btn-sm btn-link text-primary excluir-comentario-btn"
                                        data-comentario-id="{{ comentario.id }}">
                                        <i class="fas fa-trash"></i>
                                    </button>

                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    <!-- Bot√£o para abrir o Modal com todos os coment√°rios -->
                    {% if post.comentarios.count > 5 %}
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-sm btn-outline-primary btn-sm" data-bs-toggle="modal"
                            data-bs-target="#modalTodosComentarios-{{ post.id }}">
                            Ver todos os coment√°rios
                        </button>
                    </div>
                    {% endif %}

                </div>
            </div>
        </div>

        <!-- =======================
    MODAL COM TODOS COMENT√ÅRIOS
======================= -->
        <div class="modal fade" id="modalTodosComentarios-{{ post.id }}" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-scrollable modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Todos os coment√°rios</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">

                        {% for comentario in post.comentarios.all|dictsort:"data_criacao" %}
                        <div class="card mb-2 comentario" data-id="{{ comentario.id }}">
                            <div class="card-body py-2">
                                <div class="d-flex">

                                    {% if comentario.autor.perfil.foto_perfil %}
                                    <img src="{{ comentario.autor.perfil.foto_perfil.url}}" class="profile-pic-sm me-2"
                                        style="width: 35px; height: 35px; border-radius: 50%;"
                                        title="{{ comentario.autor.get_full_name|default:comentario.autor.username }}">
                                    {% else %}
                                    <!-- √çcone padr√£o se n√£o houver foto -->
                                    <i class="fas fa-user-circle fa-2x text-secondary me-2"></i>
                                    {% endif %}
                                    <div>
                                        <strong>{{ comentario.autor.username }}</strong>
                                        <p class="mb-0 comentario-texto">{{ comentario.texto }}</p>

                                        <!-- Bot√µes de editar/excluir (somente autor ou staff) -->
                                        {% if comentario.autor == request.user or request.user.is_staff %}
                                        <!-- Bot√£o para abrir o Modal -->
                                        <button type="button"
                                            class="btn btn-sm btn-link text-primary p-0 editar-comentario"
                                            data-bs-toggle="modal" data-bs-target="#modalEditarComentario"
                                            data-comentario-id="{{ comentario.id }}"
                                            data-comentario-texto="{{ comentario.texto|escape }}">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>

                                        <button class="btn btn-sm btn-link text-primary excluir-comentario-btn"
                                            data-comentario-id="{{ comentario.id }}">
                                            <i class="fas fa-trash"></i>
                                        </button>

                                        {% endif %}

                                        <small class="text-muted">{{ comentario.data_criacao|timesince }} atr√°s</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <p class="text-muted">Nenhum coment√°rio ainda.</p>
                        {% endfor %}

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    </div>
                </div>
            </div>
        </div>

 <!-- =======================
    Modal de Compartilhamento de Post
 ======================== -->
<div class="modal fade" id="modalCompartilharPost" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">üì§ Compartilhar post</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

<input type="text" id="buscaUsuario" class="form-control" placeholder="Buscar usu√°rio...">
<ul id="resultadoUsuarios" class="list-group mt-2"></ul>
<input type="hidden" id="usuarioSelecionado">
<input type="hidden" id="postIdCompartilhar">


      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarCompartilhamento()">
          üîî Enviar notifica√ß√£o
        </button>
      </div>

    </div>
  </div>
</div>
        {% empty %}
        <!-- Caso n√£o existam posts -->
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                <h5>Nenhum post ainda</h5>
                <p class="text-muted">Quando voc√™ seguir pessoas ou criar posts, eles aparecer√£o aqui.</p>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- =======================
         COLUNA LATERAL DIREITA
    ======================== -->
<div class="col-md-5">
    <div class="card sidebar">
        <div class="card-body">
            <h4 class="mb-4">Sugest√£o de quem seguir</h4>
            <div id="sugestoes-container" class="d-flex flex-wrap gap-3">
                {% for usuario in sugestoes %}
                <div class="usuario-sugestao card p-3" data-username="{{ usuario.username }}">

                    {% if usuario.perfil.foto_perfil %}
                    <img src="{{ usuario.perfil.foto_perfil.url }}" alt="{{ usuario.username }}"
                        style="width: 35px; height: 35px; border-radius: 50%;"
                        class="rounded-circle mx-auto d-block mb-2">
                    {% else %}
                    <i class="fas fa-user-circle fa-2x  me-2"></i>
                    {% endif %}

                    <p class="fw-bold mb-3">{{ usuario.username }}</p>

                    <button class="seguir-btn btn btn-primary w-100">
                        {% if usuario.ja_segue %}
                        N√£o seguir
                        {% else %}
                        Seguir
                        {% endif %}
                    </button>
                </div>
                {% empty %}
                <p class="text-muted">Nenhuma sugest√£o dispon√≠vel.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

</div>

<!-- =======================
      Modal de Edi√ß√£o
      Editar coment√°rio usando Modal Bootstrap j√° feito anteriormente
 ======================== -->
<div class="modal fade" id="modalEditarComentario" tabindex="-1" aria-labelledby="modalEditarComentarioLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarComentarioLabel">Editar Coment√°rio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar-comentario">
                    <input type="hidden" id="editar-id" name="comentario-id">
                    <div class="mb-3">
                        <label for="editar-texto" class="form-label">Texto do Coment√°rio</label>
                        <textarea class="form-control" id="editar-texto" name="texto" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Salvar altera√ß√µes</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-------------____________fim do html________________________--------------->

<!-- ======================
jQuery (menu retr√°til)
Adicione este script no final da p√°gina (depois de carregar jQuery e Bootstrap):
===========================-->
<script>
$(document).ready(function() {
    /* adiciona bot√£o flutuante se n√£o existir */
    if (!$('#btn-toggle-sidebar').length) {
        $('body').append('<button id="btn-toggle-sidebar" title="Sugest√µes"><i class="fas fa-user-friends"></i></button>');
    }

    /* alternar sidebar */
    $('#btn-toggle-sidebar').on('click', function() {
        $('.sidebar').toggleClass('active');
        const icon = $(this).find('i');
        icon.toggleClass('fa-user-friends fa-times'); /* muda √≠cone */
    });

    /* fechar ao clicar fora */
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.sidebar, #btn-toggle-sidebar').length) {
            $('.sidebar').removeClass('active');
            $('#btn-toggle-sidebar i').removeClass('fa-times').addClass('fa-user-friends');
        }
    });
});
</script>

<!------jQuery para dar feedback visual bonito ao curtir/comentar, sem alterar classes:-->

<script>
/* Exemplo de anima√ß√£o r√°pida ao curtir */
$(document).on('click', '.like-btn', function() {
    const btn = $(this);
    const heart = $('<canvas>').css({
        position: 'absolute',
        pointerEvents: 'none',
        top: btn.offset().top,
        left: btn.offset().left,
        width: 50,
        height: 50,
        zIndex: 9999
    }).appendTo('body');

    const ctx = heart[0].getContext('2d');
    let opacity = 1, scale = 1;

    const anim = setInterval(() => {
        ctx.clearRect(0, 0, 50, 50);
        ctx.globalAlpha = opacity;
        ctx.fillStyle = "#dc3545";
        ctx.beginPath();
        ctx.moveTo(25, 15);
        ctx.bezierCurveTo(25, 5, 40, 5, 40, 20);
        ctx.bezierCurveTo(40, 35, 25, 45, 25, 45);
        ctx.bezierCurveTo(25, 45, 10, 35, 10, 20);
        ctx.bezierCurveTo(10, 5, 25, 5, 25, 15);
        ctx.fill();
        opacity -= 0.05;
        scale += 0.02;
        heart.css('transform', `scale(${scale})`);
        if (opacity <= 0) {
            clearInterval(anim);
            heart.remove();
        }
    }, 30);
});

</script>

<!-- =======================
     SCRIPT: Adicionar novo coment√°rio via AJAX
========================--> 
<script>
    document.querySelectorAll('form[data-post-id]').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault(); /* Impede recarregamento da p√°gina */

            const postId = this.dataset.postId;
            const texto = this.querySelector('input[name="texto"]').value;
            const csrfToken = '{{ csrf_token }}';

            /* Requisi√ß√£o AJAX para adicionar coment√°rio */
            fetch(`/post/${postId}/comentar/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ texto })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    /* Insere o novo coment√°rio no DOM */
                    const container = document.querySelector(`#comentarios-${postId}`);
                    const novo = document.createElement('div');
                    novo.className = 'card mb-2';
                    novo.innerHTML = `
                        <div class="card-body py-2">
                            <strong>${data.autor}:</strong> ${data.texto}<br>
                            <small class="text-muted">${data.data_criacao}</small>
                        </div>
                    `;
                    container.appendChild(novo);
                    form.reset(); /* Limpa campo de texto */
                }
            });
        });
    });
</script>

<!-- =======================
     SCRIPT: Editar coment√°rio usando Modal Bootstrap j√° feito anteriormente
========================-->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('modalEditarComentario');
    const form = document.getElementById('form-editar-comentario');
    const inputId = document.getElementById('editar-id');
    const textarea = document.getElementById('editar-texto');
    const modal = new bootstrap.Modal(modalEl);

    /* Preenche o modal com os dados do coment√°rio selecionado*/
    document.querySelectorAll('.editar-comentario').forEach(botao => {
        botao.addEventListener('click', () => {
            inputId.value = botao.dataset.comentarioId;
            textarea.value = botao.dataset.comentarioTexto;
        });
    });

    /* Envia o formul√°rio do modal*/
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const comentarioId = inputId.value;
        const novoTexto = textarea.value;

        fetch(`/core/comentario/${comentarioId}/editar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `texto=${encodeURIComponent(novoTexto)}`
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const card = document.querySelector(`.comentario[data-id='${comentarioId}']`);
                card.querySelector('.comentario-texto').textContent = data.texto;
                modal.hide();
            } else {
                alert(data.error || 'Erro ao editar coment√°rio.');
            }
        });
    });
});
</script>

<!-- =======================
 SCRIPT: Seguir/Deixar de seguir usu√°rios via AJAX
 ======================= 
 Fun√ß√£o para obter o token CSRF do cookie-->
<script>
function getCookie(name) {  
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
           /*Verifica se este cookie corresponde ao nome desejado */ 
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    
/*Seguir usu√°rios */ 
/* Adiciona event listener a todos os bot√µes de seguir */

document.querySelectorAll('.follow-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const username = this.dataset.username;
        const followCount = document.querySelector('.follower-count');
        
        fetch(`/usuarios/seguir/${username}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            if (data.seguindo) {
                this.innerHTML = 'Cancelar';
                this.classList.remove('btn-primary');
                this.classList.add('btn-secondary');
            } else {
                this.innerHTML = 'Seguir';
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary');
            }
            
            /* Atualizar contador de seguidores */
            if (followCount) {
                const currentCount = parseInt(followCount.textContent);
                followCount.textContent = data.seguindo ? currentCount + 1 : currentCount - 1;
            }
        });
    });
});
    
/* Coment√°rios
Adiciona event listener a todos os formul√°rios de coment√°rio
Adiciona event listener a todos os formul√°rios de coment√°rio */
document.querySelectorAll('.comment-form').forEach(form => {
    form.addEventListener('submit', function (e) {
        e.preventDefault();

        const postId = this.dataset.postId;
        const textarea = this.querySelector('textarea');
        const commentText = textarea.value.trim();

        if (!commentText) return;

        const commentsContainer = this.closest('.post-card')?.querySelector('.comments-container');

        fetch(`/core/post/${postId}/comentar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ texto: commentText })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newComment = document.createElement('div');
                newComment.className = 'comment mb-2';
                newComment.innerHTML = `
                    <div class="d-flex">
                        ${data.foto_perfil
                            ? `<img src="${data.foto_perfil}" class="profile-pic-sm me-2" alt="${data.autor}">`
                            : `<i class="fas fa-user-circle fa-2x text-secondary me-2"></i>`}
                        <div>
                            <strong>${data.autor}</strong>
                            <p class="mb-0">${data.texto}</p>
                            <small class="text-muted">${data.data_criacao}</small>
                        </div>
                    </div>
                `;

                if (commentsContainer) {
                    commentsContainer.appendChild(newComment);
                }

                textarea.value = '';
            } else {
                alert(data.error || 'Erro ao adicionar coment√°rio');
            }
        })
        .catch(err => {
            console.error('Erro ao enviar coment√°rio:', err);
        });
    });
});

</script>

<!-- =======================
     SCRIPT: Excluir coment√°rio via AJAX
     Fun√ß√£o para mostrar mensagens tempor√°rias
========================-->
<script>
function mostrarMensagem(texto, tipo = 'sucesso') {
    let msgDiv = document.getElementById('mensagem-status');
    if (!msgDiv) {
        /* Cria o container se n√£o existir */
        msgDiv = document.createElement('div');
        msgDiv.id = 'mensagem-status';
        msgDiv.style.position = 'fixed';
        msgDiv.style.top = '10px';
        msgDiv.style.right = '10px';
        msgDiv.style.zIndex = '9999';
        msgDiv.style.padding = '10px 20px';
        msgDiv.style.borderRadius = '5px';
        msgDiv.style.color = 'white';
        msgDiv.style.display = 'none';
        document.body.appendChild(msgDiv);
    }

    msgDiv.textContent = texto;

    if (tipo === 'sucesso') {
        msgDiv.style.backgroundColor = '#28a745'; 
    } else if (tipo === 'erro') {
        msgDiv.style.backgroundColor = '#dc3545'; 
    } else {
        msgDiv.style.backgroundColor = '#6c757d'; 
    }

    msgDiv.style.display = 'block';

    /*  Esconde ap√≥s 3 segundos */
    setTimeout(() => {
        msgDiv.style.display = 'none';
    }, 3000);
}

async function excluirComentario(comentarioId, btn) {
    const url = `/core/comentario/${comentarioId}/excluir/`;
    const csrftoken = getCookie('csrftoken');

    btn.disabled = true;
    btn.classList.add('loading');

    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
            },
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            const comentarioDiv = btn.closest('.comentario');
            if (comentarioDiv) comentarioDiv.remove();
            mostrarMensagem('Coment√°rio exclu√≠do com sucesso!', 'sucesso');
        } else {
            mostrarMensagem(data.error || 'Erro ao excluir coment√°rio', 'erro');
        }
    } catch (error) {
        console.error('Erro na exclus√£o do coment√°rio:', error);
        mostrarMensagem('Erro na conex√£o. Tente novamente.', 'erro');
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

document.addEventListener('click', function(event) {
    const btn = event.target.closest('.excluir-comentario-btn');
    if (!btn) return;

    event.preventDefault();

    const comentarioId = btn.dataset.comentarioId;
    if (!comentarioId) {
        console.error('ID do coment√°rio n√£o encontrado no bot√£o');
        return;
    }

    if (confirm('Tem certeza que deseja excluir este coment√°rio?')) {
        excluirComentario(comentarioId, btn);
    }
});

</script>

<!-- =======================
 SCRIPT: Compartilhar post via Web Share API
 ======================= -->
<script>
async function prepararECompartilhar(postId) {
    try {
        const response = await fetch(
            `/core/post/${postId}/preparar-share/`,
            {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCookie("csrftoken"),
                    "X-Requested-With": "XMLHttpRequest"
                }
            }
        );

        const data = await response.json();

        if (!data.success) {
            alert("Erro ao preparar compartilhamento");
            return;
        }

        const url = data.url;
        const texto = "Achei esse conte√∫do muito interessante. Vale a pena conferir üëá";

        if (navigator.share) {
            navigator.share({
                title: "Veja este post",
                text: texto,
                url: url
            });
        } else {
            navigator.clipboard.writeText(url);
            alert("Link copiado! Agora √© s√≥ colar e compartilhar üòâ");
        }
    } catch (e) {
        console.error(e);
        alert("Erro ao compartilhar");
    }
}
</script>

<!-- =======================
 SCRIPT: Compartilhar post com notifica√ß√£o interna
 ======================= -->
<script>
let modalCompartilhar;
let debounceTimer;

document.addEventListener('DOMContentLoaded', () => {
    modalCompartilhar = new bootstrap.Modal(
        document.getElementById('modalCompartilharPost')
    );

    document.getElementById('buscaUsuario')
        .addEventListener('input', buscarUsuarios);
});

function abrirModalCompartilhar(button) {
    document.getElementById('postIdCompartilhar').value =
        button.getAttribute('data-post-id');

    document.getElementById('buscaUsuario').value = '';
    document.getElementById('resultadoUsuarios').innerHTML = '';
    document.getElementById('usuarioSelecionado').value = '';

    modalCompartilhar.show();
}

function buscarUsuarios(e) {
    const q = e.target.value.trim();
    clearTimeout(debounceTimer);

    if (q.length < 2) {
        document.getElementById('resultadoUsuarios').innerHTML = '';
        return;
    }

    debounceTimer = setTimeout(() => {
        fetch(`/mensagens/buscar_seguidores_post/?q=${encodeURIComponent(q)}`)
            .then(r => r.json())
            .then(renderizarResultados);
    }, 300);
}

function renderizarResultados(usuarios) {
    const lista = document.getElementById('resultadoUsuarios');
    lista.innerHTML = '';

    if (!usuarios.length) {
        lista.innerHTML = `<li class="list-group-item text-muted">Nenhum usu√°rio encontrado</li>`;
        return;
    }

    usuarios.forEach(u => {
        const li = document.createElement('li');
        li.className = 'list-group-item list-group-item-action';
        li.innerHTML = `
          <div class="d-flex align-items-center">
            <img src="${u.imagem_url}"
                 style="width:32px;height:32px;border-radius:50%;margin-right:10px;">
            <strong>${u.nome}</strong>
            <span class="text-muted ms-2">@${u.username}</span>
          </div>`;
        li.onclick = () => selecionarUsuario(u);
        lista.appendChild(li);
    });
}

function selecionarUsuario(usuario) {
    document.getElementById('usuarioSelecionado').value = usuario.username;
    document.getElementById('resultadoUsuarios').innerHTML = `
      <li class="list-group-item active">
        ‚úÖ ${usuario.nome} (@${usuario.username})
      </li>`;
}

function confirmarCompartilhamento() {
    const postId = document.getElementById('postIdCompartilhar').value;
    const username = document.getElementById('usuarioSelecionado').value;

    if (!username) {
        alert('Selecione um usu√°rio');
        return;
    }

    fetch(`/core/post/${postId}/notificar/${username}/`, {
        method: 'POST',
        headers: {'X-CSRFToken': getCookie('csrftoken')}
    }).then(r => {
        if (r.ok) {
            modalCompartilhar.hide();
            alert('‚úÖ Post compartilhado!');
        } else {
            alert('‚ùå Erro ao compartilhar');
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    document.cookie.split(';').forEach(c => {
        c = c.trim();
        if (c.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(c.substring(name.length + 1));
        }
    });
    return cookieValue;
}

</script>

{% endblock %}