{% extends 'base.html' %}
{% load static %}

{% block title %}Perfil de {{ usuario_perfil.username }} - SocialNet{% endblock %}

{% block content %}
{% include "mensagens/flutuante.html" %}
<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body text-center">
                    {% if usuario_perfil.perfil.foto_perfil %}
                      <img src="{{ usuario_perfil.perfil.foto_perfil.url }}" 
                          alt="{{ usuario_perfil.username }}" 
                          class="align-items-center rounded-circle me-2 " 
                          style="width: 150px; height: 150px; object-fit: cover;">
                    {% else %}
                      <i class="fas fa-user-circle fa-2x text-secondary me-2" style="width: 150px; height: 150px; object-fit: cover;"></i>
                    {% endif %}
                <h3>{{ usuario_perfil.get_full_name|default:usuario_perfil.username }}</h3>
                <p class="text-muted">@{{ usuario_perfil.username }}</p>
                
                {% if usuario_perfil.perfil.bio %}
                <p>{{ usuario_perfil.perfil.bio }}</p>
                {% endif %}
                
                <div class="d-flex justify-content-around mb-3">
                    <div class="text-center">
                        <strong class="d-block">{{ posts.count }}</strong>
                        <span class="text-muted">Publicações</span>
                    </div>
                    <div class="text-center">
                        <strong class="d-block follower-count">{{ seguidores_count }}</strong>
                        <span class="text-muted">Seguidores</span>
                    </div>
                    <div class="text-center">
                        <strong class="d-block">{{ seguindo_count }}</strong>
                        <span class="text-muted">Seguindo</span>
                    </div>
                </div>
                
                {% if usuario_perfil != user %}
                <button class="btn {% if segue %}btn-secondary{% else %}btn-primary{% endif %} w-100 follow-btn mb-2" 
                        data-username="{{ usuario_perfil.username }}">
                    {% if segue %}Deixar de Seguir{% else %}Seguir{% endif %}
                </button>
                <a href="{% url 'mensagens:conversa' usuario_perfil.username %}" a class="btn btn-primary w-100 follow-btn mb-2">
                        
                    <i class="fas fa-envelope"> Mensagem</i>
                    </a>
                {% else %}
                <a href="{% url 'editar_perfil' %}" class="btn btn-outline-primary w-100">
                    <i class="fas fa-edit"></i> Editar Perfil
                </a>
                {% endif %}
                
                {% if usuario_perfil.perfil.localizacao %}
                <div class="mt-3">
                    <i class="fas fa-map-marker-alt"></i> {{ usuario_perfil.perfil.localizacao }}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        {% if usuario_perfil == user %}
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex">

                    {% if user.perfil.foto_perfil %}
                    <img src="{{ user.perfil.foto_perfil.url }}" class="profile-pic-sm me-1" title="{{ user.username }}">
                    {% else %}
                    <i class="fas fa-user-circle fa-2x text-secondary me-2 "></i>
                    {% endif %}

                    <div class="w-100">
                        <form method="post" action="{% url 'core:feed' %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            <textarea name="conteudo" class="form-control mb-2" placeholder="O que você está pensando?" rows="3"></textarea>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <label for="imagem-perfil" class="btn btn-sm btn-outline-secondary mb-0">
                                        <i class="fas fa-image"></i> Foto
                                    </label>
                                    <input type="file" name="imagem" id="imagem-perfil" class="d-none" accept="image/*">
                                </div>
                                <button type="submit" class="btn btn-primary">Publicar</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        

        
        <div class="row">
            {% for post in posts %}
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    {% if post.imagem %}
                    <img src="{{ post.imagem.url }}" class="card-img-top" alt="Imagem do post" style="height: 200px; object-fit: cover;" title="Publicado por {{ usuario_perfil.username }}">
                    {% endif %}
                    <div class="card-body">
                        <p class="card-text">{{ post.conteudo|truncatewords:20 }}</p>
                    </div>
                    <div class="card-footer bg-transparent">
                        <small class="text-muted">{{ post.data_criacao|date:"d/m/Y H:i" }}</small>
                        <div class="float-end">
                            <i class="far fa-heart"></i> {{ post.curtidas.count }}
                            <i class="far fa-comment ms-2"></i> {{ post.comentarios.count }}
                            <form action="{% url 'core:deletar_post' post.id %}" method="post" style="display:inline;">
    {% csrf_token %}
    <button type="submit" onclick="return confirm('Tem certeza que quer deletar este post?');"class="btn btn-primary">
        Deletar
    </button>
</form>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-camera fa-3x text-muted mb-3"></i>
                        <h5>Nenhuma publicação ainda</h5>
                        <p class="text-muted">Quando {{ usuario_perfil.username }} fizer publicações, elas aparecerão aqui.</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script>
    // =======================
    // SCRIPT: Seguir/Deixar de seguir usuários via AJAX
    // ======================= 
    // Função para obter o token CSRF do cookie
function getCookie(name) {  
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Verifica se este cookie corresponde ao nome desejado
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Seguir usuários
// Adiciona event listener a todos os botões de seguir

document.querySelectorAll('.follow-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const username = this.dataset.username;
        const followCount = document.querySelector('.follower-count');
        
        fetch(`/usuarios/seguir/${username}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            
            if (data.seguindo) {
                this.innerHTML = 'Cancelar';
                this.classList.remove('btn-primary');
                this.classList.add('btn-secondary');
            } else {
                this.innerHTML = 'Seguir';
                this.classList.remove('btn-secondary');
                this.classList.add('btn-primary');
            }
            
            // Atualizar contador de seguidores
            if (followCount) {
                const currentCount = parseInt(followCount.textContent);
                followCount.textContent = data.seguindo ? currentCount + 1 : currentCount - 1;
            }
        });
    });
});
</script>

{% endblock %}
